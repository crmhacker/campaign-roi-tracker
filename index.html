<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta
    name="viewport"
    content="width=device-width, initial-scale=1"
  />
  <title>CRM Hacker — Live ROI Tracking Demo</title>
  <meta
    name="description"
    content="Watch your own UTM, device, geo, and engagement data populate in real time — and see how CRM Hacker uses it to prove campaign ROI."
  />
  <meta name="theme-color" content="#15a3d4" />
  <!-- Minimal, light theme aligned to crmhacker.com -->
  <style>
    :root{
      /* Light, airy palette (adjust if you want exact brand hexes) */
      --bg:#ffffff;
      --text:#0f172a;          /* slate-900 */
      --muted:#475569;         /* slate-600 */
      --line:#e2e8f0;          /* slate-200 */
      --card:#ffffff;
      --shadow:0 8px 24px rgba(15,23,42,.06);
      --brand:#15a3d4;         /* teal/sky accent */
      --brand2:#06b6d4;        /* secondary accent */
      --ok:#22c55e;            /* green */
      --warn:#f59e0b;          /* amber */
      --radius:14px;
    }
    *{box-sizing:border-box}
    html,body{height:100%}
    body{
      margin:0;
      font-family: Inter,ui-sans-serif,system-ui,Segoe UI,Roboto,Arial,sans-serif;
      background:var(--bg);
      color:var(--text);
      -webkit-font-smoothing:antialiased;
    }
    .container{max-width:1200px;margin:0 auto;padding:28px}
    /* Header */
    .hero{
      background:
        radial-gradient(900px 300px at 20% -10%, rgba(21,163,212,.12), transparent 60%),
        radial-gradient(700px 280px at 80% -10%, rgba(6,182,212,.10), transparent 60%),
        var(--bg);
      border-bottom:1px solid var(--line);
    }
    .hero-inner{display:flex;gap:18px;align-items:center;padding:34px 0;flex-wrap:wrap}
    .brand{display:flex;align-items:center;gap:14px;border:1px solid var(--line);background:#fff;border-radius:12px;padding:10px 12px}
    .logoBox{width:52px;height:52px;border-radius:12px;display:grid;place-items:center;overflow:hidden;background:
      linear-gradient(145deg, var(--brand), var(--brand2));box-shadow:var(--shadow)}
    .logoBox img{width:100%;height:100%;object-fit:contain;background:#fff}
    h1{font-size:clamp(26px,4vw,40px);line-height:1.12;margin:0 0 8px}
    .sub{color:var(--muted);margin:0}
    /* Sections */
    .section{margin:38px 0}
    .section-title{display:flex;align-items:flex-end;justify-content:space-between;gap:12px;margin-bottom:14px}
    .kicker{font-size:12px;letter-spacing:.12em;text-transform:uppercase;color:var(--muted)}
    .h2{font-size:22px;margin:4px 0 0}
    .lead{color:var(--muted);margin:8px 0 0}
    .card{background:var(--card);border:1px solid var(--line);border-radius:var(--radius);padding:18px;box-shadow:var(--shadow)}
    /* Tiles: 4-across with lots of white space */
    .tiles{display:grid;gap:12px}
    @media(min-width:1040px){.tiles.cols-4{grid-template-columns:repeat(4,1fr)}}
    @media(min-width:680px) and (max-width:1039px){.tiles.cols-4{grid-template-columns:repeat(2,1fr)}}
    @media(max-width:679px){.tiles.cols-4{grid-template-columns:1fr}}
    .tile{background:#fff;border:1px solid var(--line);border-radius:12px;padding:12px;box-shadow:var(--shadow)}
    .tile h3{font-size:14px;margin:0 0 8px}
    .kv{display:flex;align-items:center;justify-content:space-between;gap:8px;border:1px dashed var(--line);padding:8px 10px;border-radius:10px;background:#fafcff}
    .kv label{color:var(--muted);font-size:11px}
    .kv code{
      font-family:ui-monospace,SFMono-Regular,Menlo,monospace;
      background:#f8fafc;border:1px solid var(--line);padding:2px 6px;border-radius:8px;max-width:70%;
      overflow:hidden;text-overflow:ellipsis;white-space:nowrap;color:#0b1220
    }
    .why{font-size:11px;color:var(--muted);margin-top:8px;line-height:1.55}
    /* Flow & CTA */
    .flow{display:grid;gap:12px;margin-top:6px}
    @media(min-width:900px){.flow{grid-template-columns:repeat(5,1fr)}}
    .step{position:relative;padding:14px;border:1px solid var(--line);border-radius:12px;background:#fff;box-shadow:var(--shadow)}
    .step:after{content:"→";position:absolute;right:-10px;top:50%;transform:translateY(-50%);color:#94a3b8}
    .step:last-child:after{display:none}
    .sm{font-size:12px;color:var(--muted)}
    .cta{
      display:flex;flex-wrap:wrap;gap:14px;align-items:center;justify-content:space-between;background:#f7fdff;border:1px solid var(--line);border-radius:12px;padding:18px
    }
    .btn{
      background:var(--brand);color:#fff;border:none;border-radius:10px;padding:12px 16px;font-weight:800;
      cursor:pointer;box-shadow:var(--shadow);text-decoration:none;display:inline-block
    }
    .btn.secondary{background:#fff;color:var(--text);border:1px solid var(--line)}
    .notice{background:#f8fafc;border:1px solid var(--line);border-radius:12px;padding:12px}
    .footer{color:var(--muted);font-size:12px;margin:28px 0}
    /* Chart cards */
    .chart-grid{display:grid;gap:14px}
    @media(min-width:980px){.chart-grid.cols-3{grid-template-columns:2fr 1fr 1fr}}
  </style>

  <!-- Chart.js + PDF (CDNs keep this one-file) -->
  <script defer src="https://cdn.jsdelivr.net/npm/chart.js@4.4.1/dist/chart.umd.min.js"></script>
  <script defer src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
  <script defer src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
</head>

<body>
  <!-- HERO -->
  <header class="hero">
    <div class="container hero-inner">
      <div class="brand">
        <div class="logoBox">
          <img id="brandLogo" alt="CRM Hacker logo" />
        </div>
        <div>
          <div style="font-weight:800" id="brandName">CRM Hacker</div>
          <div class="sub" id="brandTag">Salesforce & RevOps done right</div>
        </div>
      </div>
      <div>
        <h1 id="heroLine">From click → closed: watch your data populate in real time.</h1>
        <p class="sub">A quiet, clear view of what we track — and how we turn it into revenue reporting.</p>
      </div>
    </div>
  </header>

  <main class="container">
    <div class="notice">We capture URL params (UTMs & click IDs), referrer, device, IP geo, and on-page engagement. No paid enrichment — this is the minimum viable proof.</div>

    <!-- ACQUISITION -->
    <section class="section">
      <div class="section-title">
        <div>
          <div class="kicker">Acquisition & Attribution</div>
          <h2 class="h2">Where did this click come from?</h2>
        </div>
      </div>
      <p class="lead">These fields power channel/campaign/keyword ROI and platform de-dupe.</p>

      <div class="tiles cols-4" style="margin-top:14px">
        <div class="tile"><h3>Referrer</h3><div class="kv"><label>value</label><code id="referrer">—</code></div><p class="why">Separates paid, organic, partner, and direct traffic.</p></div>
        <div class="tile"><h3>Landing URL</h3><div class="kv"><label>value</label><code id="landingUrl">—</code></div><p class="why">Persists UTMs across sessions; great for audits.</p></div>
        <div class="tile"><h3>utm_source</h3><div class="kv"><label>value</label><code id="utm_source">—</code></div><p class="why">Channel/source (google, linkedin…). Core to ROI by channel.</p></div>
        <div class="tile"><h3>utm_medium</h3><div class="kv"><label>value</label><code id="utm_medium">—</code></div><p class="why">Traffic type (cpc, social, email). Normalize for clean reports.</p></div>
        <div class="tile"><h3>utm_campaign</h3><div class="kv"><label>value</label><code id="utm_campaign">—</code></div><p class="why">Budget shifts + goal tracking at campaign level.</p></div>
        <div class="tile"><h3>utm_content</h3><div class="kv"><label>value</label><code id="utm_content">—</code></div><p class="why">Creative/variant ID for A/Bs.</p></div>
        <div class="tile"><h3>utm_term</h3><div class="kv"><label>value</label><code id="utm_term">—</code></div><p class="why">Keyword. Expand/negate based on ROI.</p></div>
        <div class="tile">
          <h3>Click IDs</h3>
          <div class="kv"><label>gclid</label><code id="gclid">—</code></div>
          <div class="kv" style="margin-top:6px"><label>fbclid</label><code id="fbclid">—</code></div>
          <div class="kv" style="margin-top:6px"><label>msclkid</label><code id="msclkid">—</code></div>
          <div class="kv" style="margin-top:6px"><label>ttclid</label><code id="ttclid">—</code></div>
          <div class="kv" style="margin-top:6px"><label>li_fat_id</label><code id="li_fat_id">—</code></div>
          <p class="why">Platform join keys for offline conversions & lift studies.</p>
        </div>
        <div class="tile">
          <h3>Campaign Group</h3>
          <div class="kv"><label>value</label><code id="campaignGroup">—</code></div>
          <p class="why">Auto buckets: google-ads, linkedin-ads, email, direct…</p>
        </div>
      </div>
    </section>

    <!-- DEVICE -->
    <section class="section">
      <div class="section-title">
        <div>
          <div class="kicker">Device & Environment</div>
          <h2 class="h2">How are they experiencing your page?</h2>
        </div>
      </div>
      <p class="lead">Design & QA follow the buyer’s setup — device, OS, browser, screen.</p>

      <div class="tiles cols-4" style="margin-top:14px">
        <div class="tile"><h3>Device Type</h3><div class="kv"><label>value</label><code id="deviceType">—</code></div><p class="why">Mobile vs Desktop → layout & CTAs.</p></div>
        <div class="tile"><h3>OS</h3><div class="kv"><label>value</label><code id="os">—</code></div><p class="why">OS-specific bugs; creative specs.</p></div>
        <div class="tile"><h3>Browser</h3><div class="kv"><label>value</label><code id="browser">—</code></div><p class="why">QA for Safari/Firefox quirks.</p></div>
        <div class="tile"><h3>Screen</h3><div class="kv"><label>value</label><code id="screen">—</code></div><p class="why">Hero sizing, fold placement.</p></div>
        <div class="tile" style="grid-column:span 4"><h3>User Agent</h3><div class="kv"><label>value</label><code id="ua">—</code></div><p class="why">Debugging & client hints if needed.</p></div>
      </div>
    </section>

    <!-- GEO -->
    <section class="section">
      <div class="section-title">
        <div>
          <div class="kicker">Geo & Org</div>
          <h2 class="h2">Where is this click coming from?</h2>
        </div>
      </div>
      <p class="lead">IP-based geo and org/ISP provide weak but useful hints for routing & messaging.</p>

      <div class="tiles cols-4" style="margin-top:14px">
        <div class="tile"><h3>IP</h3><div class="kv"><label>value</label><code id="ip">—</code></div><p class="why">Fraud checks; geo joining.</p></div>
        <div class="tile"><h3>City</h3><div class="kv"><label>value</label><code id="city">—</code></div><p class="why">Localization & tests.</p></div>
        <div class="tile"><h3>Region</h3><div class="kv"><label>value</label><code id="region">—</code></div><p class="why">Bid modifiers; territory routing.</p></div>
        <div class="tile"><h3>Country</h3><div class="kv"><label>value</label><code id="country">—</code></div><p class="why">Compliance, language, pricing.</p></div>
        <div class="tile"><h3>Org / ISP</h3><div class="kv"><label>value</label><code id="org">—</code></div><p class="why">Occasional corporate hint.</p></div>
      </div>
    </section>

    <!-- ENGAGEMENT -->
    <section class="section">
      <div class="section-title">
        <div>
          <div class="kicker">Engagement</div>
          <h2 class="h2">Are they actually engaging?</h2>
        </div>
      </div>
      <p class="lead">High-signal, privacy-light metrics for qualification and CRO.</p>

      <div class="tiles cols-4" style="margin-top:14px">
        <div class="tile"><h3>Time on Page</h3><div class="kv"><label>value</label><code id="timeOnPage">0s</code></div><p class="why">Trigger nudges, qualify MQLs.</p></div>
        <div class="tile"><h3>Scroll Depth</h3><div class="kv"><label>value</label><code id="scrollDepth">0%</code></div><p class="why">Content resonance.</p></div>
        <div class="tile"><h3>Pageviews (session)</h3><div class="kv"><label>value</label><code id="pageviews">1</code></div><p class="why">Interest score; funnel triggers.</p></div>
      </div>
    </section>

    <!-- ANALYTICS-LIKE CHARTS -->
    <section class="section">
      <div class="section-title">
        <div>
          <div class="kicker">Dashboards</div>
          <h2 class="h2">Quick visuals (GA-style)</h2>
        </div>
      </div>
      <div class="chart-grid cols-3">
        <div class="card">
          <div class="kicker">Source Grouping</div>
          <canvas id="sourceDonut" height="180"></canvas>
          <p class="sub">Buckets by UTMs/click IDs: google-ads, linkedin-ads, email, direct…</p>
        </div>
        <div class="card">
          <div class="kicker">Device & OS</div>
          <canvas id="deviceBar" height="180"></canvas>
          <p class="sub">Breakdown of your current environment vs example historical mix.</p>
        </div>
        <div class="card">
          <div class="kicker">Engagement (this visit)</div>
          <canvas id="engageLine" height="180"></canvas>
          <p class="sub">Simulated timeline of seconds on page & scroll milestones.</p>
        </div>
      </div>
    </section>

    <!-- JOURNEY & ROI -->
    <section class="section">
      <div class="section-title">
        <div>
          <div class="kicker">From Click to Revenue</div>
          <h2 class="h2">How this connects to ROI</h2>
        </div>
      </div>
      <div class="flow">
        <div class="step"><strong>1) Ad Click</strong><br><span class="sm">UTMs + clids captured</span></div>
        <div class="step"><strong>2) Web Session</strong><br><span class="sm">Device, geo, engagement</span></div>
        <div class="step"><strong>3) Lead</strong><br><span class="sm">Form capture + enrichment</span></div>
        <div class="step"><strong>4) Pipeline</strong><br><span class="sm">Opp with source</span></div>
        <div class="step"><strong>5) Revenue</strong><br><span class="sm">Closed won → campaign ROI</span></div>
      </div>
      <div class="card" style="margin-top:14px">
        <div class="kicker">Sample Projection (demo values)</div>
        <p class="sub">Click est. cost: <strong id="projCost">$4.00</strong> • Similar-click pipeline: <strong id="projPipe">$12,000</strong> • Close rate: <strong id="projClose">21%</strong> • Est. revenue: <strong id="projRev">$2,520</strong></p>
      </div>
    </section>

    <!-- CTA -->
    <section class="section cta">
      <div>
        <div class="kicker">Next step</div>
        <div class="h2" style="margin:0 0 6px">Connect your stack and get the full ROI picture.</div>
        <p class="sub" style="margin:0">We wire this into Salesforce + ad platforms so marketing, sales, and finance share one truth.</p>
      </div>
      <a class="btn" id="ctaBtn" href="https://calendly.com/crmhacker_jonathan" target="_blank" rel="noopener">Book an ROI Strategy Call</a>
    </section>

    <!-- UTILS -->
    <section class="section tiles cols-4">
      <button class="btn secondary" id="downloadPdfBtn">Download as PDF</button>
      <a class="btn secondary" href="#" onclick="window.scrollTo({top:0,behavior:'smooth'})">Back to top</a>
    </section>

    <div class="footer">
      <div class="notice">
        <strong>Transparency:</strong> This demo uses public signals (UTMs, referrer, device, IP geo, on-page behavior). Corporate identification and deeper intent typically require paid enrichment or first-party integrations. Update your privacy policy accordingly.
      </div>
      <p class="sub" style="margin-top:10px">© <span id="footBrand">CRM Hacker</span>. All rights reserved.</p>
    </div>
  </main>

 <script>
/* ================== SAFE HELPERS ================== */
const SAFE = {
  $: (id) => document.getElementById(id),
  set: (id, v) => { const el = SAFE.$(id); if (el) el.textContent = (v ?? "—"); },
  on: (id, evt, fn) => { const el = SAFE.$(id); if (el && el.addEventListener) el.addEventListener(evt, fn); },
  warn: (...args) => console.warn("[ROI-DEMO]", ...args),
  err:  (...args) => console.error("[ROI-DEMO]", ...args),
};

window.addEventListener("error", (e) => SAFE.err("window error:", e.message));
window.addEventListener("unhandledrejection", (e) => SAFE.err("unhandled promise:", e.reason));

/* ================== UTM PARSING (robust) ================== */
const COMMON_PARAMS = ["utm_source","utm_medium","utm_campaign","utm_content","utm_term","gclid","fbclid","msclkid","ttclid","li_fat_id"];
function parseQuery() {
  const out = {};
  const q = location.search.startsWith("?") ? location.search.slice(1) : location.search;
  if (!q) return out;
  for (const part of q.split("&")) {
    if (!part) continue;
    const [kRaw, vRaw=""] = part.split("=");
    const k = decodeURIComponent(kRaw||"").trim().toLowerCase();
    const v = decodeURIComponent(vRaw||"").trim();
    if (!k) continue;
    out[k] = v;
  }
  return out;
}
function persistParams() {
  const p = parseQuery();
  const prev = JSON.parse(sessionStorage.getItem("params") || "{}");
  const next = { ...prev };
  for (const k of COMMON_PARAMS) if (p[k]) next[k] = p[k];
  next.landingUrl = location.href;
  sessionStorage.setItem("params", JSON.stringify(next));
  return next;
}
function getReferrer(){ return document.referrer || "(direct / none)"; }
function campaignGrouping(params){
  const src = (params.utm_source||"").toLowerCase();
  const med = (params.utm_medium||"").toLowerCase();
  if(params.gclid) return "google-ads";
  if(params.fbclid) return "meta-ads";
  if(params.msclkid) return "microsoft-ads";
  if(params.li_fat_id) return "linkedin-ads";
  if(src.includes("linkedin")) return "linkedin";
  if(src.includes("google")) return "google-other";
  if(src.includes("newsletter")||med==="email") return "email";
  if(!src && !document.referrer) return "direct";
  return `${src||"unknown"}-${med||"unknown"}`;
}

/* ================== DEVICE INFO (no network) ================== */
function deviceInfo(){
  const ua = navigator.userAgent || "";
  const isMobile = /Mobi|Android/i.test(ua);
  const os = /Windows NT/i.test(ua) ? "Windows" :
             /Mac OS X/i.test(ua) ? "macOS" :
             /Android/i.test(ua) ? "Android" :
             /iPhone|iPad|iPod/i.test(ua) ? "iOS" :
             /Linux/i.test(ua) ? "Linux" : "Other";
  const browser = /Chrome/i.test(ua) && !/Edg/i.test(ua) ? "Chrome" :
                  /Edg/i.test(ua) ? "Edge" :
                  /Firefox/i.test(ua) ? "Firefox" :
                  /Safari/i.test(ua) && !/Chrome/i.test(ua) ? "Safari" :
                  /Opera|OPR/i.test(ua) ? "Opera" : "Other";
  const screenSize = `${window.screen.width}×${window.screen.height}`;
  return { type: isMobile ? "Mobile" : "Desktop", os, browser, screen: screenSize, ua };
}

/* ================== GEO IP (with fallbacks + timeout) ================== */
function withTimeout(promise, ms=3500){
  let t; return Promise.race([
    promise, new Promise((_,rej)=> t=setTimeout(()=>rej(new Error("timeout")), ms))
  ]).finally(()=> clearTimeout(t));
}
async function geoFromIpapi(){
  const r = await withTimeout(fetch("https://ipapi.co/json/"), 3500);
  if (!r.ok) throw new Error("ipapi bad status");
  const j = await r.json();
  return { ip:j.ip||null, city:j.city||null, region:j.region||null, country:j.country_name||j.country||null, org:j.org||j.asn||null };
}
async function geoFromIpwho(){
  const r = await withTimeout(fetch("https://ipwho.is/"), 3500);
  if (!r.ok) throw new Error("ipwho bad status");
  const j = await r.json();
  if (j && j.success !== false) {
    return { ip:j.ip||null, city:j.city||null, region:j.region||null, country:j.country||null, org:j.connection?.org||null };
  }
  throw new Error("ipwho failed flag");
}
async function geoFromGeoJS(){
  const r = await withTimeout(fetch("https://get.geojs.io/v1/ip/geo.json"), 3500);
  if (!r.ok) throw new Error("geojs bad status");
  const j = await r.json();
  return { ip:j.ip||null, city:j.city||null, region:j.region||null, country:j.country||null, org:j.organization_name||null };
}
async function ipOnlyIpify(){
  const r = await withTimeout(fetch("https://api.ipify.org?format=json"), 3500);
  if (!r.ok) throw new Error("ipify bad status");
  const j = await r.json();
  return { ip:j.ip||null, city:null, region:null, country:null, org:null };
}
async function geoLookup(){
  for (const fn of [geoFromIpapi, geoFromIpwho, geoFromGeoJS, ipOnlyIpify]) {
    try { const g = await fn(); if (g) return g; }
    catch(e){ SAFE.warn("geo fallback:", e.message); }
  }
  return { ip:null, city:null, region:null, country:null, org:null };
}

/* ================== SESSION METRICS (guarded) ================== */
const sessionMetrics = { start: Date.now(), scrollMax: 0, pageviews: 1, timeline: [] };
(function initPV(){
  try{
    const key="pv"; const cur=Number(sessionStorage.getItem(key)||"0")+1;
    sessionStorage.setItem(key,String(cur)); sessionMetrics.pageviews = cur;
  }catch(e){ SAFE.warn("sessionStorage disabled?", e.message); }
})();
window.addEventListener("scroll", ()=>{
  try{
    const depth = Math.round(100 * (window.scrollY + window.innerHeight) / document.body.scrollHeight);
    sessionMetrics.scrollMax = Math.min(100, Math.max(sessionMetrics.scrollMax, depth));
  }catch(e){/* ignore */}
});
setInterval(()=>{
  const t = Math.round((Date.now()-sessionMetrics.start)/1000);
  sessionMetrics.timeline.push({t, depth: sessionMetrics.scrollMax});
  renderSession();
  try { updateEngageChart(); } catch(e){/* charts may be absent */}
}, 1000);

/* ================== RENDERERS (null-safe) ================== */
function renderAcq(params){
  SAFE.set("referrer", getReferrer());
  SAFE.set("landingUrl", params.landingUrl || location.href);
  ["utm_source","utm_medium","utm_campaign","utm_content","utm_term","gclid","fbclid","msclkid","ttclid","li_fat_id"]
    .forEach(k => SAFE.set(k, params[k] || "—"));
  const group = campaignGrouping(params);
  SAFE.set("campaignGroup", group);
  try { updateSourceDonut(group); } catch(e){ /* charts optional */ }
}
function renderDevice(d){
  SAFE.set("deviceType", d.type); SAFE.set("os", d.os); SAFE.set("browser", d.browser);
  SAFE.set("screen", d.screen);   SAFE.set("ua", d.ua);
  try { updateDeviceBar(d); } catch(e){ /* charts optional */ }
}
function renderGeo(g){
  SAFE.set("ip", g.ip); SAFE.set("city", g.city); SAFE.set("region", g.region);
  SAFE.set("country", g.country); SAFE.set("org", g.org);
}
function renderSession(){
  const elapsed = Math.round((Date.now()-sessionMetrics.start)/1000);
  SAFE.set("timeOnPage", `${elapsed}s`);
  SAFE.set("scrollDepth", `${sessionMetrics.scrollMax}%`);
  SAFE.set("pageviews", String(sessionMetrics.pageviews));
}

/* ================== CHARTS (guard every call) ================== */
let sourceDonut, deviceBar, engageLine;
function initCharts(){
  if (!window.Chart) { SAFE.warn("Chart.js not available; skipping charts"); return; }
  try{
    const brand = getComputedStyle(document.documentElement).getPropertyValue('--brand').trim() || '#15a3d4';
    const brand2 = getComputedStyle(document.documentElement).getPropertyValue('--brand2').trim() || '#06b6d4';

    const sd = SAFE.$('sourceDonut');
    if (sd) {
      sourceDonut = new Chart(sd, {
        type: 'doughnut',
        data: {
          labels: ['google-ads','linkedin-ads','email','direct','other'],
          datasets: [{ data: [0,0,0,0,1], backgroundColor: [brand, brand2, '#22c55e', '#e5e7eb', '#cbd5e1'] }]
        },
        options: { plugins: { legend: { position: 'bottom' } }, cutout: '60%' }
      });
    }

    const db = SAFE.$('deviceBar');
    if (db) {
      deviceBar = new Chart(db, {
        type: 'bar',
        data: {
          labels: ['Desktop / Windows','Desktop / macOS','Mobile / iOS','Mobile / Android'],
          datasets: [{
            label: 'This visit', data: [0,0,0,0], backgroundColor: brand
          },{
            label: 'Example mix', data: [35,25,20,20], backgroundColor: '#e2e8f0'
          }]
        },
        options: {
          plugins: { legend: { position: 'bottom' } },
          scales: { y: { beginAtZero: true, ticks: { stepSize: 10 } } }
        }
      });
    }

    const el = SAFE.$('engageLine');
    if (el) {
      engageLine = new Chart(el, {
        type: 'line',
        data: { labels: [], datasets: [{ label: 'Depth %', data: [], borderColor: brand, tension: .3 }] },
        options: {
          plugins: { legend: { display: false } },
          scales: { x:{ title:{ display:true, text:'Seconds'} }, y:{ title:{ display:true, text:'Scroll depth %'}, suggestedMin:0, suggestedMax:100 } }
        }
      });
    }
  }catch(e){ SAFE.err("chart init failed", e); }
}
function updateSourceDonut(group){
  if(!sourceDonut) return;
  const map = { 'google-ads':0,'linkedin-ads':1,'email':2,'direct':3 };
  const idx = map[group] ?? 4;
  sourceDonut.data.datasets[0].data[idx] += 1;
  sourceDonut.update();
}
function updateDeviceBar(d){
  if(!deviceBar) return;
  const idx = (d.type==='Desktop' && d.os==='Windows') ? 0
            : (d.type==='Desktop' && d.os==='macOS') ? 1
            : (d.type==='Mobile' && d.os==='iOS') ? 2
            : (d.type==='Mobile' && d.os==='Android') ? 3
            : 0;
  deviceBar.data.datasets[0].data = [0,0,0,0];
  deviceBar.data.datasets[0].data[idx] = 1;
  deviceBar.update();
}
function updateEngageChart(){
  if(!engageLine) return;
  const last = sessionMetrics.timeline[sessionMetrics.timeline.length-1];
  if(!last) return;
  engageLine.data.labels.push(last.t);
  engageLine.data.datasets[0].data.push(last.depth);
  if(engageLine.data.labels.length>60){ engageLine.data.labels.shift(); engageLine.data.datasets[0].data.shift(); }
  engageLine.update();
}

/* ================== PDF (optional, guarded) ================== */
async function downloadPDF(){
  try{
    if (!window.jspdf || !window.jspdf.jsPDF) throw new Error("jsPDF unavailable");
    const el = document.querySelector("main");
    const canvas = await html2canvas(el);
    const imgData = canvas.toDataURL("image/png");
    const { jsPDF } = window.jspdf;
    const pdf = new jsPDF({ orientation:"p", unit:"pt", format:"a4" });
    const pageW = pdf.internal.pageSize.getWidth(), pageH = pdf.internal.pageSize.getHeight();
    const margin = 24, imgW = pageW - margin*2, ratio = canvas.height / canvas.width, imgH = imgW * ratio;
    pdf.text("Live ROI Tracking Demo", margin, 28);
    if(imgH <= pageH - 60){ pdf.addImage(imgData, "PNG", margin, 40, imgW, imgH); }
    else {
      const sliceH = pageH - 80; let y = 0, page = 0;
      while(y < canvas.height){
        const slice = document.createElement("canvas");
        slice.width = canvas.width; slice.height = Math.min(sliceH * canvas.width / imgW, canvas.height - y);
        slice.getContext("2d").drawImage(canvas, 0, y, canvas.width, slice.height, 0, 0, slice.width, slice.height);
        const img = slice.toDataURL("image/png"); if(page>0) pdf.addPage();
        pdf.addImage(img, "PNG", margin, 40, imgW, (slice.height / canvas.width) * imgW);
        y += slice.height; page++;
      }
    }
    pdf.save("Live_Tracking_Report.pdf");
  }catch(e){ SAFE.warn("PDF export skipped:", e.message); }
}
SAFE.on("downloadPdfBtn", "click", downloadPDF);

/* ================== INIT (always render something) ================== */
(async function init(){
  initCharts();

  const params = persistParams();
  renderAcq(params);

  const dev = deviceInfo();
  renderDevice(dev);

  try {
    const geo = await geoLookup();
    renderGeo(geo);
  } catch(e) {
    SAFE.warn("geo failed entirely:", e.message);
  }

  // Demo projection (static)
  SAFE.set("projCost", "$4.00");
  SAFE.set("projPipe", "$12,000");
  SAFE.set("projClose", "21%");
  SAFE.set("projRev", "$2,520");
})();
</script>

</body>
</html>
